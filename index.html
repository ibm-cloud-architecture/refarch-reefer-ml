



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.1">
    
    
      
        <title>Reefer Container Predictive Maintenance</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/application.982221ab.css">
      
      
    
    
      <script src="assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#reefer-predictive-maintenance-solution" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="." title="Reefer Container Predictive Maintenance" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Reefer Container Predictive Maintenance
            </span>
            <span class="md-header-nav__topic">
              Introduction
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/jbcodeforce/refarch-reefer-ml/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="." title="Reefer Container Predictive Maintenance" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Reefer Container Predictive Maintenance
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/jbcodeforce/refarch-reefer-ml/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Introduction
      </label>
    
    <a href="." title="Introduction" class="md-nav__link md-nav__link--active">
      Introduction
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#component-view" title="Component view" class="md-nav__link">
    Component view
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pre-requisites" title="Pre-requisites" class="md-nav__link">
    Pre-requisites
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#building-the-python-environment-as-docker-image" title="Building the python environment as docker image" class="md-nav__link">
    Building the python environment as docker image
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#be-sure-to-have-event-stream-or-kafka-running" title="Be sure to have Event Stream or kafka running" class="md-nav__link">
    Be sure to have Event Stream or kafka running
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#machine-learning-work" title="Machine Learning Work" class="md-nav__link">
    Machine Learning Work
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#generate-data-with-the-reefer-simulator" title="Generate data with the Reefer simulator" class="md-nav__link">
    Generate data with the Reefer simulator
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#start-python-env" title="Start python env" class="md-nav__link">
    Start python env
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generate-power-off-metrics" title="Generate power off metrics" class="md-nav__link">
    Generate power off metrics
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generate-co2-sensor-malfunction-in-same-file" title="Generate Co2 sensor malfunction in same file" class="md-nav__link">
    Generate Co2 sensor malfunction in same file
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-the-model" title="Create the model" class="md-nav__link">
    Create the model
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-simulator-as-web-app" title="The Simulator as web app" class="md-nav__link">
    The Simulator as web app
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#run-it-locally" title="Run it locally" class="md-nav__link">
    Run it locally
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simulator-build-and-run-on-opentshift" title="Simulator: Build and run on OpentShift" class="md-nav__link">
    Simulator: Build and run on OpentShift
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#test-sending-a-simulation-control-to-the-post-api" title="Test sending a simulation control to the POST api" class="md-nav__link">
    Test sending a simulation control to the POST api
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-predictive-scoring-microservice" title="The predictive scoring microservice" class="md-nav__link">
    The predictive scoring microservice
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#run-locally" title="Run locally" class="md-nav__link">
    Run locally
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scoring-build-and-run-on-openshift" title="Scoring: Build and run on Openshift" class="md-nav__link">
    Scoring: Build and run on Openshift
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="integration-tests/" title="Run integration tests" class="md-nav__link">
      Run integration tests
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="predictive-maintenance/" title="Reefer Container Predictive Maintenance" class="md-nav__link">
      Reefer Container Predictive Maintenance
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#component-view" title="Component view" class="md-nav__link">
    Component view
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pre-requisites" title="Pre-requisites" class="md-nav__link">
    Pre-requisites
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#building-the-python-environment-as-docker-image" title="Building the python environment as docker image" class="md-nav__link">
    Building the python environment as docker image
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#be-sure-to-have-event-stream-or-kafka-running" title="Be sure to have Event Stream or kafka running" class="md-nav__link">
    Be sure to have Event Stream or kafka running
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#machine-learning-work" title="Machine Learning Work" class="md-nav__link">
    Machine Learning Work
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#generate-data-with-the-reefer-simulator" title="Generate data with the Reefer simulator" class="md-nav__link">
    Generate data with the Reefer simulator
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#start-python-env" title="Start python env" class="md-nav__link">
    Start python env
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generate-power-off-metrics" title="Generate power off metrics" class="md-nav__link">
    Generate power off metrics
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generate-co2-sensor-malfunction-in-same-file" title="Generate Co2 sensor malfunction in same file" class="md-nav__link">
    Generate Co2 sensor malfunction in same file
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-the-model" title="Create the model" class="md-nav__link">
    Create the model
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-simulator-as-web-app" title="The Simulator as web app" class="md-nav__link">
    The Simulator as web app
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#run-it-locally" title="Run it locally" class="md-nav__link">
    Run it locally
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simulator-build-and-run-on-opentshift" title="Simulator: Build and run on OpentShift" class="md-nav__link">
    Simulator: Build and run on OpentShift
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#test-sending-a-simulation-control-to-the-post-api" title="Test sending a simulation control to the POST api" class="md-nav__link">
    Test sending a simulation control to the POST api
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-predictive-scoring-microservice" title="The predictive scoring microservice" class="md-nav__link">
    The predictive scoring microservice
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#run-locally" title="Run locally" class="md-nav__link">
    Run locally
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scoring-build-and-run-on-openshift" title="Scoring: Build and run on Openshift" class="md-nav__link">
    Scoring: Build and run on Openshift
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/jbcodeforce/refarch-reefer-ml/edit/master/docs/index.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="reefer-predictive-maintenance-solution">Reefer Predictive Maintenance Solution</h1>
<p>This project is to demonstrate how to perform real time analytics, like predictive maintenance scoring from Reefer container metric event stream. The runtime environment in production may look like in the following diagram:</p>
<p><img alt="" src="images/RT-analytics.png" /></p>
<p>The Reefer container is a IoT device, which emits container metrics every 15 minutes via the MQTT protocol. The first component receiving those messages is Apache Nifi to transform the metrics message to a kafka event. Kafka is used as the event backbone and event sourcing so microservices, deployed on openshift, can consume and publish messages.</p>
<p>For persistence reason, we may leverage big data type of storage like Cassandra to persist the container metrics over a longer time period. This datasource is used by the Data Scientists to do its data preparation and build training and test sets and build model.</p>
<p>Data scientists can run Jupyter lab on OpenShift and build a model to be deployed as python microservice, consumer of kafka Reefer metrics events. The action will be to change the state of the Reefer entity via an events to the <code>containers</code> topic. </p>
<h2 id="component-view">Component view</h2>
<p>While for the minimum viable demonstration the components looks like in the figure below:</p>
<p><img alt="" src="images/mvp-runtime.png" /></p>
<ol>
<li>
<p>A web app, deployed on Openshift, is running a simulator to simulate the generation of Reefer container metrics while the container is at sea or during end to end transportation. The app exposes a simple POST operation with a control object to control the simulation. Here is an example of such control.json</p>
<div class="codehilite"><pre><span></span><span class="p">{</span> <span class="err">&#39;containerID&#39;:</span> <span class="err">&#39;c100&#39;,</span>
<span class="err">&#39;simulation&#39;:</span> <span class="err">&#39;co2sensor&#39;,</span>
<span class="err">&#39;nb_of_records&#39;:</span> <span class="err">1000,</span>
<span class="err">&#39;good_temperature&#39;:</span> <span class="err">4.4</span>
<span class="p">}</span>
</pre></div>

<p>See <a href="#the-simulator-as-webapp">this section to build and deploy</a> the simulator web app.</p>
</li>
<li>
<p>A curl script will do the post of this json object. <a href="#test-sending-a-simulation-control-to-the-post-api">See this paragraph.</a></p>
</li>
<li>The metrics events are sent to the <code>containerMetrics</code> topic in Kafka.</li>
<li>The predictive scoring is a consumer of such events, read one event at a time and call the model internally, then sends a new event when maintenance is required. <a href="/#the-predictive-scoring-microservice">See the note</a> for details.</li>
<li>The maintenance requirement is an event in the <code>containers</code> topic.</li>
<li>The last element is to trace the container maintenance event, in real application, this component should trigger a business process to get human performing the maintenance. The <a href="">following repository</a> is the microservice we could use on as this component, but we have a simple consumer in the <code>consumer</code> folder.</li>
</ol>
<h2 id="pre-requisites">Pre-requisites</h2>
<p>Start by cloning this project using the command:</p>
<div class="codehilite"><pre><span></span>git clone https://github.com/ibm-cloud-architecture/refarch-reefer-ml
</pre></div>

<h3 id="building-the-python-environment-as-docker-image">Building the python environment as docker image</h3>
<p>To avoid impacting our environment, we use a dockerfile to get the basic of python 3.7.x and other needed modules like kafka, http requests, pytest... So to build your python image with all the needed libraries, use the following commands:</p>
<div class="codehilite"><pre><span></span>cd docker
docker build -f docker-python-tools -t ibmcase/python .
</pre></div>

<h3 id="be-sure-to-have-event-stream-or-kafka-running">Be sure to have Event Stream or kafka running</h3>
<p>Create the Event Stream service using the <a href="https://cloud.ibm.com/catalog/services/event-streams">IBM Cloud catalog</a>, you can also read our <a href="https://ibm-cloud-architecture.github.io/refarch-kc/deployments/iks/#event-streams-service-on-ibm-cloud">quick article</a> on this event stream cloud deployment. We also have deployed Event Stream in cloud private deployment as described <a href="https://ibm-cloud-architecture.github.io/refarch-eda/deployments/eventstreams/">here</a>.</p>
<p>The following diagram illustrates the topics configured in IBM Cloud Event Stream service:</p>
<p><img alt="" src="images/es-topics.png" /></p>
<p>In the service credentials creates new credentials to get the Kafka broker list, the admin URL and the api_key needed to authenticate the consumers or producers.</p>
<h2 id="machine-learning-work">Machine Learning Work</h2>
<p>To review the problem of predictive maintenance read <a href="predictive-maintenance/">this article.</a></p>
<h3 id="generate-data-with-the-reefer-simulator">Generate data with the Reefer simulator</h3>
<p>Well we do not have real Reefer data. But we may be able to simulate them. As this is not production work, we should be able to get the end to end story still working from a solution point of view.</p>
<p>The historical data need to represent failure, and represent the characteristics of a Reefer container. We can imagine it includes a lot of sensors to get interesting correlated or independant features.</p>
<p>We have implemented a simulator to create those metrics to be used to build the model inside Jupiter notebook and with sklearn or tensorflow library. </p>
<h4 id="start-python-env">Start python env</h4>
<div class="codehilite"><pre><span></span> <span class="p">.</span><span class="o">/</span><span class="n">startPythonEnv</span> 

<span class="n">root</span><span class="mf">@03721594782f</span><span class="o">:</span> <span class="n">cd</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">simulator</span>
</pre></div>

<p>From this shell, first specify where python should find the new modules, by setting the environment variable PYTHONPATH:</p>
<div class="codehilite"><pre><span></span><span class="n">root</span><span class="mf">@03721594782f</span><span class="o">:/</span><span class="err">#</span> <span class="n">export</span> <span class="n">PYTHONPATH</span><span class="o">=/</span><span class="n">home</span>
</pre></div>

<h4 id="generate-power-off-metrics">Generate power off metrics</h4>
<p>When the reefer containers lose power at some time, the temperature within the container starts raising.</p>
<p>The simulator accepts different arguments: </p>
<div class="codehilite"><pre><span></span>usage reefer_simulator-tool --stype [poweroff | co2sensor | atsea]
     --cid &lt;container ID&gt;
     --records &lt;the number of records to generate&gt;
     --temp &lt;expected temperature for the goods&gt;
     --file &lt;the filename to create (without .csv)&gt;
     --append [yes | no]  (reuse the data file)
</pre></div>

<div class="codehilite"><pre><span></span>    <span class="n">root</span><span class="mf">@03721594782f</span><span class="o">:</span> <span class="n">python</span> <span class="n">reefer_simulator_tool</span><span class="p">.</span><span class="n">py</span> <span class="o">--</span><span class="n">stype</span> <span class="n">poweroff</span> <span class="o">--</span><span class="n">cid</span> <span class="mi">101</span> <span class="o">--</span><span class="n">records</span> <span class="mi">1000</span> <span class="o">--</span><span class="n">temp</span> <span class="mi">4</span> <span class="o">--</span><span class="n">file</span> <span class="p">..</span><span class="o">/</span><span class="n">ml</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">metrics</span><span class="p">.</span><span class="n">csv</span> <span class="o">--</span><span class="n">append</span> <span class="n">yes</span>

    <span class="n">Generating</span>  <span class="mi">1000</span>  <span class="n">poweroff</span> <span class="n">metrics</span>

    <span class="n">Timestamp</span>   <span class="n">ID</span>  <span class="n">Temperature</span><span class="p">(</span><span class="n">celsius</span><span class="p">)</span> <span class="n">Target_Temperature</span><span class="p">(</span><span class="n">celsius</span><span class="p">)</span>      <span class="n">Power</span>  <span class="n">PowerConsumption</span> <span class="n">ContentType</span>  <span class="n">O2</span> <span class="n">CO2</span>  <span class="n">Time_Door_Open</span> <span class="n">Maintenance_Required</span> <span class="n">Defrost_Cycle</span>
    <span class="mf">1.000000</span>  <span class="mi">2019</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">30</span> <span class="nl">T15</span><span class="p">:</span><span class="mi">43</span> <span class="n">Z</span>  <span class="mi">101</span>              <span class="mf">3.416766</span>                           <span class="mi">4</span>  <span class="mf">17.698034</span>          <span class="mf">6.662044</span>           <span class="mi">1</span>  <span class="mi">11</span>   <span class="mi">1</span>        <span class="mf">8.735273</span>                    <span class="mi">0</span>             <span class="mi">6</span>
    <span class="mf">1.001001</span>  <span class="mi">2019</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">30</span> <span class="nl">T15</span><span class="p">:</span><span class="mi">43</span> <span class="n">Z</span>  <span class="mi">101</span>              <span class="mf">4.973630</span>                           <span class="mi">4</span>   <span class="mf">3.701072</span>          <span class="mf">8.457314</span>           <span class="mi">1</span>  <span class="mi">13</span>   <span class="mi">3</span>        <span class="mf">5.699655</span>                    <span class="mi">0</span>             <span class="mi">6</span>
    <span class="mf">1.002002</span>  <span class="mi">2019</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">30</span> <span class="nl">T15</span><span class="p">:</span><span class="mi">43</span> <span class="n">Z</span>  <span class="mi">101</span>              <span class="mf">1.299275</span>                           <span class="mi">4</span>   <span class="mf">7.629094</span> 
</pre></div>

<h4 id="generate-co2-sensor-malfunction-in-same-file">Generate Co2 sensor malfunction in same file</h4>
<p>In the same way as above the simulator can generate data for Co2 sensor malfunction using the command:</p>
<div class="codehilite"><pre><span></span>python reefer_simulator_tool.py --stype co2sensor --cid 101 --records 1000 --temp 4 --file ../ml/data/metrics.csv --append yes
</pre></div>

<div class="admonition note">
<p class="admonition-title">Note<p>The simulator is integrated in the event producer to send real time events to kafka, as if the Reefer container was loaded with fresh goods and is travelling oversea. A consumer code can call the predictive model to assess if maintenance is required and post new event on a <code>containers</code> topic.</p>
</p>
</div>
<h3 id="create-the-model">Create the model</h3>
<p>Now we will use a local version of <strong>Jupyter</strong> notebook to load the logistic regression nodebook in the <code>ml</code> folder. </p>
<ol>
<li>
<p>Start a jupyter server using a docker image:</p>
<div class="codehilite"><pre><span></span>cd ml
docker run --rm -p 10000:8888 -v &quot;$PWD&quot;:/home/jovyan/work jupyter/datascience-notebook
</pre></div>

</li>
<li>
<p>Then open a web browser to <code>http://localhost:10000</code> and then open the <code>model_logistic_regression.ipynb</code> and run it step by step. The notebook includes comments to explain how the model is done. We use logistic regression to build a binary classification (maintenance required or not), as the data are simulated, and the focus is not in the model building, but more on the end to end process.
The notebook persists the trained model as a pickle file so it can be loaded by a python module or another model.</p>
<p>For more information on using the Jupyter notebook, here is a <a href="https://jupyter-docker-stacks.readthedocs.io/en/latest/index.html">product documentation</a>.</p>
</li>
<li>
<p>Use the model in another notebook: We can use a second notebook to assess some one record test using the pickle serialized model. The notebook is named <code>predictMaintenance.ipynb</code></p>
</li>
</ol>
<h2 id="the-simulator-as-web-app">The Simulator as web app</h2>
<p>This is a simple python Flask web app exposing a REST POST end point and producing Reefer metrics event to kafka. 
The POST operation in on the /control url. The control object, to generate 1000 events with the co2sensor simulation looks like:</p>
<div class="codehilite"><pre><span></span>    <span class="p">{</span> <span class="err">&#39;containerID&#39;:</span> <span class="err">&#39;c100&#39;,</span>
    <span class="err">&#39;simulation&#39;:</span> <span class="err">&#39;co2sensor&#39;,</span>
    <span class="err">&#39;nb_of_records&#39;:</span> <span class="err">1000,</span>
    <span class="err">&#39;good_temperature&#39;:</span> <span class="err">4.4</span>
    <span class="p">}</span>
</pre></div>

<h3 id="run-it-locally">Run it locally</h3>
<p>To build the simulator using the <a href="https://github.com/openshift/source-to-image">s2i CLI</a>:</p>
<div class="codehilite"><pre><span></span>s2i build --copy .  centos/python-36-centos7 ibmcase/reefersimulator
</pre></div>

<p>Then to run it locally, use the local script <code>./runReeferSimulator.sh</code> or after setting the environment variables for kafka launch the docker container like:</p>
<div class="codehilite"><pre><span></span>docker run -p 8080:8080 -e KAFKA_ENV=$KAFKA_ENV -e KAFKA_BROKERS=$KAFKA_BROKERS -e KAFKA_APIKEY=$KAFKA_APIKEY ibmcase/reefersimulator
</pre></div>

<h3 id="simulator-build-and-run-on-opentshift">Simulator: Build and run on OpentShift</h3>
<p>To deploy the code to an openshift cluster do the following:</p>
<ol>
<li>
<p>Login to the openshift cluster. </p>
<div class="codehilite"><pre><span></span>oc login -u apikey -p &lt;apikey&gt; --server=https://...
</pre></div>

</li>
<li>
<p>Create a project if not done already:</p>
<div class="codehilite"><pre><span></span>oc  new-project reefershipmentsolution --description=&quot;A Reefer container shipment solution&quot;
</pre></div>

<p><em>Remember the project is mapped to a kubernestes namespace, but includes other componetns too</em></p>
</li>
<li>
<p>Create an app from the source code, and use source to image build process to deploy the app. You can use a subdirectory of your source code repository by specifying a --context-dir flag.</p>
<div class="codehilite"><pre><span></span>oc new-app python:latest~https://github.com/ibm-cloud-architecture/refarch-reefer-ml.git --context-dir=simulator --name reefersimulator
</pre></div>

<p>Then to track the build progress:
<div class="codehilite"><pre><span></span>oc logs -f bc/reefersimulator
</pre></div>
The dependencies are loaded, the build is scheduled and executed, the image is uploaded to the registry, and started.</p>
</li>
<li>
<p>To display information about the build configuration for the application:</p>
<div class="codehilite"><pre><span></span>oc describe bc/reefersimulator
</pre></div>

</li>
<li>
<p>To trigger a remote build (run on Openshift) from local source code do the following command:</p>
<div class="codehilite"><pre><span></span>oc start-build reefersimulator --from-file=.
</pre></div>

</li>
<li>
<p>Set environment variables</p>
<p>For Broker URLs
<div class="codehilite"><pre><span></span>oc set env dc/reefersimulator KAFKA_BROKERS=kafka03-prod02.messagehub.services.us-south.blu....
</pre></div></p>
<p>For apikey:
<div class="codehilite"><pre><span></span>oc set env dc/reefersimulator KAFKA_APIKEY=&quot;&quot;
</pre></div></p>
<p>For the kafka runtime env: </p>
<div class="codehilite"><pre><span></span> oc set env dc/reefersimulator KAFKA_ENV=&quot;IBM_CLOUD&quot;
</pre></div>

<p>Get all environment variables set for a given pod: (det the pod id with <code>oc get pod</code>)</p>
<div class="codehilite"><pre><span></span>oc set env pod/reefersimulator-4-tq27j --list
</pre></div>

<p><img alt="" src="images/env-variables.png" /></p>
</li>
<li>
<p>Once the build is done you should see the container up and running</p>
<div class="codehilite"><pre><span></span>oc get pod

reefersimulator-3-build         0/1       Completed    0          15m
reefersimulator-3-jdh2v         1/1       Running      0          1m
</pre></div>

<div class="admonition note">
<p class="admonition-title">Note<p>The first time the container start, it may crash as he environment variables like KAFKA_APIKEY is not defined. You can use the  <code>./scripts/setenv.sh SET</code> command to create the needed environment variable.</p>
</p>
</div>
</li>
<li>
<p>To make it visible externally, you need to add a route for this deployment:</p>
</li>
</ol>
<p>Use <code>Create Route</code> button on top right, </p>
<p><img alt="" src="images/create-routes.png" /></p>
<p>The enter a name and select the existing service</p>
<p><img alt="" src="images/simul-route-create.png" /></p>
<p>Once created, the URL of the app is visible in the route list panel:</p>
<p><img alt="" src="images/simul-route.png" /></p>
<p>Add the host name in your local /etc/hosts or be sure the hostname is defined in DNS server. Map to the IP address of the kubernetes proxy server end point.</p>
<h2 id="test-sending-a-simulation-control-to-the-post-api">Test sending a simulation control to the POST api</h2>
<p>The script <code>sendSimulControl.sh</code> is used for that. </p>
<div class="codehilite"><pre><span></span>```
pwd

refarch-reefer-ml

cd scripts
./sendSimulControl.sh reefersimulatorroute-reefershipmentsolution.apps.green-with-envy.ocp.csplab.local co2sensor

```

Looking at the logs from the pod using `oc logs reefersimulator-3-jdh2v` you can see something like:

```
 &quot;POST /order HTTP/1.1&quot; 404 232 &quot;-&quot; &quot;curl/7.54.0&quot;
{&#39;containerID&#39;: &#39;c100&#39;, &#39;simulation&#39;: &#39;co2sensor&#39;, &#39;nb_of_records&#39;: 10, &#39;good_temperature&#39;: 4.4}
Generating  10  Co2 metrics

```

We will see how those events are processed in the next section.
</pre></div>


<h2 id="the-predictive-scoring-microservice">The predictive scoring microservice</h2>
<p>Applying the same pattern as the simulation webapp, we implement a kafka consumer and producer in python that call the serialized analytic model. The code in the <code>scoring</code> folder.</p>
<p>Applying a TDD approach we start by a TestScoring.py class.</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">scoring.predictservice</span> <span class="kn">import</span> <span class="n">PredictService</span>

<span class="k">class</span> <span class="nc">TestScoreMetric</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">testCreation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">serv</span> <span class="o">=</span> <span class="n">PredictService</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</pre></div>

<p>Use the same python environment with docker:</p>
<div class="codehilite"><pre><span></span><span class="p">.</span><span class="o">/</span><span class="n">startPythonEnv</span>
<span class="n">root</span><span class="mi">@1</span><span class="nl">de81b16f940</span><span class="p">:</span><span class="o">/</span><span class="err">#</span> <span class="n">cd</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">scoring</span><span class="o">/</span>
<span class="n">root</span><span class="mi">@1</span><span class="nl">de81b16f940</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">scoring</span><span class="err">#</span> <span class="n">python</span> <span class="n">TestScoring</span><span class="p">.</span><span class="n">py</span> 
</pre></div>

<p>Test fails, so let add the scoring service with a constructor, and load the serialized pickle model (which was copied from the ml folder).</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">pickle</span>

<span class="k">class</span> <span class="nc">PredictService</span><span class="p">:</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;model_logistic_regression.pkl&quot;</span><span class="p">,</span><span class="s2">&quot;rb&quot;</span><span class="p">),</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin1&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">metricEvent</span><span class="p">):</span>
        <span class="n">TESTDATA</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">metricEvent</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">TESTDATA</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Temperature(celsius)&#39;</span><span class="p">,</span><span class="s1">&#39;Target_Temperature(celsius)&#39;</span><span class="p">,</span><span class="s1">&#39;Power&#39;</span><span class="p">,</span><span class="s1">&#39;PowerConsumption&#39;</span><span class="p">,</span><span class="s1">&#39;ContentType&#39;</span><span class="p">,</span><span class="s1">&#39;O2&#39;</span><span class="p">,</span><span class="s1">&#39;CO2&#39;</span><span class="p">,</span><span class="s1">&#39;Time_Door_Open&#39;</span><span class="p">,</span><span class="s1">&#39;Maintenance_Required&#39;</span><span class="p">,</span><span class="s1">&#39;Defrost_Cycle&#39;</span><span class="p">]</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</pre></div>

<p>Next we need to test a predict on an event formated as a csv string. The test looks like:</p>
<div class="codehilite"><pre><span></span>    serv = PredictService()
    header=&quot;&quot;&quot;Timestamp, ID, Temperature(celsius), Target_Temperature(celsius), Power, PowerConsumption, ContentType, O2, CO2, Time_Door_Open, Maintenance_Required, Defrost_Cycle&quot;&quot;&quot;
    event=&quot;2019-04-01 T16:29 Z,1813, 101, 4.291843460900875,4.4,0,10.273342381017777,3,4334.920958996634,4.9631508046318755,1,0,6&quot;&quot;&quot;
    record=header+&quot;\n&quot;+event
    print(serv.predict(record))
</pre></div>

<p>So the scoring works, now we need to code the scoring application that will be deployed to Openshift cluster, and which acts as a consumer of container metrics events and a producer container events. </p>
<p>The Scoring App code of this app is <a href="https://github.com/ibm-cloud-architecture/refarch-reefer-ml/blob/master/scoring/ScoringApp.py">ScoringApp.py</a> module. It starts a consumer to get messages from Kafka. And when a message is received, it needs to do some data extraction and transformation and then use the predictive service.</p>
<p>During the tests we have issue in the data quality, so it is always a good practice to add a validation function to assess if all the records are good. For production, this code needs to be enhanced for better error handling an reporting.</p>
<h3 id="run-locally">Run locally</h3>
<p>Under <code>scoring</code> folder, set the environment variables for KAFKA using the commands</p>
<div class="codehilite"><pre><span></span>export KAFKA_BROKERS=broker-3.eventstreams.cloud.ibm.com:9093,broker-1.eventstreams.cloud.ibm.com:9093,broker-0.eventstreams.cloud.ibm.com:9093,broker-5.eventstreams.cloud.ibm.com:9093,broker-2.eventstreams.cloud.ibm.com:9093,broker-4.eventstreams.cloud.ibm.com:9093
export KAFKA_APIKEY=&quot;&quot;
export KAFKA_ENV=IBMCLOUD

docker run -e KAFKA_BROKERS=$KAFKA_BROKERS -e KAFKA_APIKEY=$KAFKA_APIKEY -e KAFKA_ENV=$KAFKA_ENV -v $(pwd)/..:/home -ti ibmcase/python bash -c &quot;cd /home/scoring &amp;&amp; export PYTHONPATH=/home &amp;&amp; python ScoringApp.py&quot;
</pre></div>

<p>The following script does these things for you:</p>
<div class="codehilite"><pre><span></span>./runScoringApp.sh 
</pre></div>

<h3 id="scoring-build-and-run-on-openshift">Scoring: Build and run on Openshift</h3>
<p>The first time we need to add the application to the existing project, run the following command:</p>
<div class="codehilite"><pre><span></span>oc new-app python:latest~https://github.com/ibm-cloud-architecture/refarch-reefer-ml.git --context-dir=scoring --name reeferpredictivescoring
</pre></div>

<p>This command will run a source to image, build all the needed yaml files for the kubernetes deployment and start the application in a pod. It use the <code>--context</code> flag to define what to build and run. With this capability we can use the same github repository for different sub component.</p>
<p>As done for simulator, the scoring service needs environment variables. We can set them using the commands</p>
<div class="codehilite"><pre><span></span>oc set env dc/reeferpredictivescoring KAFKA_BROKERS=$KAFKA_BROKERS
oc set env dc/reeferpredictivescoring KAFKA_ENV=$KAFKA_ENV
oc set env dc/reeferpredictivescoring KAFKA_APIKEY=$KAFKA_APIKEY
</pre></div>

<p>but we have added a script for you to do so. This script needs only to be run at the first deployment. It leverage the common setenv scripts:</p>
<div class="codehilite"><pre><span></span>./os-setenv.sh
</pre></div>

<p>The list of running pods should show the build pods for this application:</p>
<div class="codehilite"><pre><span></span> oc get pods
 reeferpredictivescoring-1-build   1/1       Running      0          24s
</pre></div>

<p>To run the build again after commit code to github:</p>
<div class="codehilite"><pre><span></span>oc start-build reeferpredictivescoring 
</pre></div>

<p>To see the log:</p>
<div class="codehilite"><pre><span></span> oc logs reeferpredictivescoring-2-rxr6j
</pre></div>

<p>To be able to run on Openshift, the APP_FILE environment variable has to be set to ScoringApp.py. This can be done in the <code>environment</code> file under the <code>.s2i</code> folder.</p>
<p>The scoring service has no API exposed to the external world, so we do not need to create a <code>Route</code> or ingress.</p>
<p>See the <a href="#integration-tests">integration test</a> section to see a demonstration of the solution end to end.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
        
          <a href="integration-tests/" title="Run integration tests" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Run integration tests
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="assets/javascripts/application.b806dc00.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"."}})</script>
      
    
  </body>
</html>