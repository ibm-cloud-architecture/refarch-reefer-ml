



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.1">
    
    
      
        <title>Develop the simulation app - Reefer Container Predictive Maintenance</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.982221ab.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#the-simulator-as-web-app" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="Reefer Container Predictive Maintenance" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Reefer Container Predictive Maintenance
            </span>
            <span class="md-header-nav__topic">
              Develop the simulation app
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/ibm-cloud-architecture/refarch-reefer-ml/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="Reefer Container Predictive Maintenance" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Reefer Container Predictive Maintenance
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/ibm-cloud-architecture/refarch-reefer-ml/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      Introduction
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        Introduction
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../.." title="What you will learn" class="md-nav__link">
      What you will learn
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../analyze/predictive-maintenance/" title="Reefer anomaly detection problem" class="md-nav__link">
      Reefer anomaly detection problem
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Enablement Content
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Enablement Content
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-data-ai-analytics/methodology/" title="Methodology used" class="md-nav__link">
      Methodology used
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cp-approach/" title="Cloud Pak approach" class="md-nav__link">
      Cloud Pak approach
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../oos-approach/" title="Open source approach" class="md-nav__link">
      Open source approach
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Environments
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Environments
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../environments/event-streams/" title="Event Streams environment" class="md-nav__link">
      Event Streams environment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../environments/mongo/" title="MongoDB on IBM Cloud" class="md-nav__link">
      MongoDB on IBM Cloud
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../environments/postgresql/" title="Postgresql on IBM Cloud" class="md-nav__link">
      Postgresql on IBM Cloud
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../environments/cp4d/" title="Cloud pak for Data" class="md-nav__link">
      Cloud pak for Data
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      AI Ladder
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        AI Ladder
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-1" type="checkbox" id="nav-4-1">
    
    <label class="md-nav__link" for="nav-4-1">
      Collect
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-1">
        Collect
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-1-1" type="checkbox" id="nav-4-1-1">
    
    <label class="md-nav__link" for="nav-4-1-1">
      Preparing data for demonstration
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-4-1-1">
        Preparing data for demonstration
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../collect/products-postgres/" title="Define products reference data" class="md-nav__link">
      Define products reference data
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../collect/generate-telemetry/" title="Generate telemetry data" class="md-nav__link">
      Generate telemetry data
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../collect/oss-collect-data/" title="Collect data with open source solution" class="md-nav__link">
      Collect data with open source solution
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../collect/cp4d-collect-data/" title="Collect data with cloud pak for data" class="md-nav__link">
      Collect data with cloud pak for data
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../organize/readme/" title="Organize" class="md-nav__link">
      Organize
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-3" type="checkbox" id="nav-4-3">
    
    <label class="md-nav__link" for="nav-4-3">
      Analyze
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-3">
        Analyze
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../analyze/oss-ml-dev/" title="Define the anomaly detection scoring model with OSS" class="md-nav__link">
      Define the anomaly detection scoring model with OSS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../analyze/ws-ml-dev/" title="Define the anomaly detection scoring model with Watson Studio" class="md-nav__link">
      Define the anomaly detection scoring model with Watson Studio
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-4" type="checkbox" id="nav-4-4" checked>
    
    <label class="md-nav__link" for="nav-4-4">
      Infuse
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-4">
        Infuse
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Develop the simulation app
      </label>
    
    <a href="./" title="Develop the simulation app" class="md-nav__link md-nav__link--active">
      Develop the simulation app
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#design-approach" title="Design approach" class="md-nav__link">
    Design approach
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code-approach" title="Code approach" class="md-nav__link">
    Code approach
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing" title="Testing" class="md-nav__link">
    Testing
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unit-test-the-simulator" title="Unit test the Simulator" class="md-nav__link">
    Unit test the Simulator
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#build" title="Build" class="md-nav__link">
    Build
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#build-locally-with-docker" title="Build locally with docker" class="md-nav__link">
    Build locally with docker
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#openshift-source-to-image" title="Openshift  source to image" class="md-nav__link">
    Openshift  source to image
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../dev-scoring/" title="Develop scoring app with cloud pak for application" class="md-nav__link">
      Develop scoring app with cloud pak for application
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../build-run/" title="Build and run the solution on Openshift" class="md-nav__link">
      Build and run the solution on Openshift
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../integration-tests/" title="Run integration tests" class="md-nav__link">
      Run integration tests
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../bpm/readme/" title="Engineer dispatching with Business process with Cloud Pak for Automation" class="md-nav__link">
      Engineer dispatching with Business process with Cloud Pak for Automation
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../devops/" title="Devops" class="md-nav__link">
      Devops
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../bpm/readme/" title="Engineer dispatching with Business process with Cloud Pak for Automation" class="md-nav__link">
      Engineer dispatching with Business process with Cloud Pak for Automation
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../workshop/" title="Do it yourself - Workshop" class="md-nav__link">
      Do it yourself - Workshop
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-kc/" title="Reefer solution implementation project" class="md-nav__link">
      Reefer solution implementation project
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#design-approach" title="Design approach" class="md-nav__link">
    Design approach
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code-approach" title="Code approach" class="md-nav__link">
    Code approach
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing" title="Testing" class="md-nav__link">
    Testing
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unit-test-the-simulator" title="Unit test the Simulator" class="md-nav__link">
    Unit test the Simulator
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#build" title="Build" class="md-nav__link">
    Build
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#build-locally-with-docker" title="Build locally with docker" class="md-nav__link">
    Build locally with docker
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#openshift-source-to-image" title="Openshift  source to image" class="md-nav__link">
    Openshift  source to image
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/ibm-cloud-architecture/refarch-reefer-ml/edit/master/docs/infuse/simul-app.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="the-simulator-as-web-app">The Simulator as web app</h1>
<p>The Simulator webapp is a simple python (3.7) Flask web app exposing a REST POST end point to control the type of simulation to run and to produce Reefer telemetry events to kafka <code>reeferTelemetry</code> topic. </p>
<p>A POST operation in the <code>/control</code> URL with a json control object like below will create 1000 records simulating issue on the CO2 sensor for the container C02 which carry the product referenced as P02:</p>
<div class="codehilite"><pre><span></span>    <span class="p">{</span> <span class="err">&#39;containerID&#39;:</span> <span class="err">&#39;C02&#39;,</span>
    <span class="err">&#39;simulation&#39;:</span> <span class="err">&#39;co2sensor&#39;,</span>
    <span class="err">&#39;nb_of_records&#39;:</span> <span class="err">1000,</span>
    <span class="nt">&quot;product_id&quot;</span><span class="p">:</span>  <span class="s2">&quot;P02&quot;</span>
    <span class="p">}</span>
</pre></div>

<h2 id="design-approach">Design approach</h2>
<p>We have tried to support a domain driven design approach to structure the code, with domain, infrastructure and app modules. The domain module has a unique class for the simulator which main goals is to generate tuples or records for the different simulation types. It is reused for the standalone simulation tools to generate data at rest.</p>
<p>As the simulator is also a webapp we need to package it with <a href="https://www.fullstackpython.com/flask.html">Flask</a> and run it using one of the Web Server Gateway Interface (WSGI) implementation with <a href="http://docs.gunicorn.org/">Gunicorn</a>.</p>
<p>We recommend to follow <a href="https://flask.palletsprojects.com/en/1.1.x/tutorial/">Flask tutorial</a> if you do not know this python library to develop web app or REST service.</p>
<p>Flask is a simple library to implement REST based microservice and web application in python. It has other related projects to add interesting features to develop production application. The standard development includes defining routes, function to support handling the request and generating HTTP response, but also defining APIs... Read more with the <a href="http://exploreflask.com/en/latest/">explore Flask book online</a>.
Flask is mono threaded so it fits well in a simple web application for development purpose, but for production it is recommended to add a web server like <a href="https://gunicorn.org/">Gunicorn</a> to handle multiple concurrent requests.</p>
<h2 id="code-approach">Code approach</h2>
<p>The app is done using Flask, and the code is generated using <code>appsody init python-flask</code> command with the Python Flask appsody stack and template. </p>
<p><img alt="Appsody components" src="../images/appsody-concept.png" /></p>
<p>Appsody helps developer to do not worry about the details of k8s deployment and build. During a Appsody run, debug or test step (2), Appsody creates a Docker container based on the parent stack Dockerfile, and combines application code with the source code in the template.</p>
<p>We recommend reading <a href="https://github.com/appsody/stacks/tree/master/incubator/python-flask">the Python Flask Stack git hub repo</a> to get familiar with appsody python stack.</p>
<p>This appsody stack is defining the Flask application, and import the 'userapp' then use blueprints to define APIs. </p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">userapp</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">server.routes.health</span> <span class="kn">import</span> <span class="n">health_bp</span>
<span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">health_bp</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">server.routes.prometheus</span> <span class="kn">import</span> <span class="n">metrics_bp</span>
<span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">metrics_bp</span><span class="p">)</span>
</pre></div>

<p>This code is not updatable as it is part of the image. But we can add our business logic as part of the <code>simulator/__init__.py</code> code and within <a href="https://flask.palletsprojects.com/en/1.1.x/blueprints/">Flask blueprints</a> modules.</p>
<p>The <code>userapp</code> module is defined when appsody integrates our code with the stack base image using Docker. Below is an extract of the docker file managing module installation and defining what appsody does during build, run and test:</p>
<div class="codehilite"><pre><span></span>ENV APPSODY_MOUNTS=/:/project/userapp
ENV APPSODY_DEPS=/project/deps
WORKDIR /project
RUN python -m pip install -r requirements.txt -t /project/deps
ENV FLASK_APP=server/__init__.py
</pre></div>

<p>Looking at the content of the final docker container running the application we can see this structure:
<div class="codehilite"><pre><span></span>/project
|-- Dockerfile  
    Pipfile  
    Pipfile.lock  
    constraints.txt  
    requirements.txt
    deps/    
    server/
    test/  
    userapp/
</pre></div></p>
<p>The basic concept of blueprints is that they record operations to execute when registered on an application. So to add the operation to support the control we add a blueprint, and then register it in the main application: <code>__init__py</code>.</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">userapp.api.controller</span> <span class="kn">import</span> <span class="n">control_blueprint</span>
<span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">control_blueprint</span><span class="p">)</span>
</pre></div>

<p>To define the API, we use <a href="https://github.com/flasgger/flasgger">Flasgger</a> as an extension to Flask to extract <a href="https://swagger.io/docs/specification/about/">Open API specification</a> from the code. It comes with Swagger UI, so we can see the API documentation of the microservice at the URL <code>/apidocs</code>.  It can also validate the data according to the schema defined. </p>
<p>For the POST /control we define the using Swagger 2.0 the API in a separate file: <code>api/controlapi.yml</code> and import it at the method level to support the POSt operation. This method is defined in its blueprint as a REST resource. The code <code>controller.py</code> is under <code>api</code> folder.</p>
<p>The pipfile defines the dependencies for this component. </p>
<h2 id="testing">Testing</h2>
<h3 id="unit-test-the-simulator">Unit test the Simulator</h3>
<p>The test coverage is not yet great. To run them</p>
<div class="codehilite"><pre><span></span><span class="n">cd</span> <span class="n">simulator</span>
<span class="p">.</span><span class="o">/</span><span class="n">startPythonEnv</span>
<span class="n">root</span><span class="mi">@1</span><span class="nl">de81b16f940</span><span class="p">:</span><span class="o">/</span><span class="err">#</span> <span class="n">export</span> <span class="n">PYTHONPATH</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">simulator</span>
<span class="n">root</span><span class="mi">@1</span><span class="nl">de81b16f940</span><span class="p">:</span><span class="o">/</span><span class="err">#</span> <span class="n">cd</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">simulator</span>
<span class="n">root</span><span class="mi">@1</span><span class="nl">de81b16f940</span><span class="p">:</span><span class="o">/</span><span class="err">#</span> <span class="n">python</span> <span class="n">tests</span><span class="o">/</span><span class="n">unit</span><span class="o">/</span><span class="n">TestSimulator</span><span class="p">.</span><span class="n">py</span> 
</pre></div>

<h2 id="build">Build</h2>
<p>We have multiple build approaches depending of the environment: local, openshift source to image, github actions.</p>
<h3 id="build-locally-with-docker">Build locally with docker</h3>
<p>The goal is to build the docker image, publish it to docker hub registry or a private registry, which then can be deployed to any kubernetes environment or run using docker compose:</p>
<div class="codehilite"><pre><span></span><span class="c1"># In simulator folder</span>
docker build -t ibmcase/kcontainer-reefer-simulator .
docker login
docker push ibmcase/kcontainer-reefer-simulator
&gt; The push refers to repository <span class="o">[</span>docker.io/ibmcase/kcontainer-reefer-simulator<span class="o">]</span>
</pre></div>

<p>The scripts: <code>scripts/runReeferSimulatorApp.sh IBMCLOUD</code> should run the simulator docker image with Event Streams on IBM Cloud.</p>
<h3 id="openshift-source-to-image">Openshift  source to image</h3>
<p>To build and deploy the code to an OpenShift cluster, using the source 2 image approach, do the following steps:</p>
<ol>
<li>
<p>Login to the OpenShift cluster. </p>
<div class="codehilite"><pre><span></span>oc login -u apikey -p &lt;apikey&gt; --server=https://...
</pre></div>

<p><em>To find the API key and server URL go to the openshift console under your account, to access the <code>Copy login command</code> menu.</em> </p>
</li>
<li>
<p>Create a project if you did not create one already:</p>
<div class="codehilite"><pre><span></span>oc  new-project reefershipmentsolution --description=&quot;A Reefer container shipment solution&quot;
</pre></div>

<p><em>Remember the project is mapped to a kubernetes namespace, but includes other components too</em></p>
</li>
<li>
<p>The first deploy you need to create a new app from the source code, and use source to image build process to deploy the app. You can use a subdirectory of your source code repository by specifying a --context-dir flag.</p>
<div class="codehilite"><pre><span></span>oc new-app python:latest~https://github.com/ibm-cloud-architecture/refarch-reefer-ml.git --context-dir=simulator --name reefersimulator
</pre></div>

<p>Then to track the build progress, look at the logs of the build pod:</p>
<p><div class="codehilite"><pre><span></span>oc logs -f bc/reefersimulator
</pre></div>
The dependencies are loaded, the build is scheduled and executed, the image is uploaded to the registry, and started.</p>
</li>
<li>
<p>To display information about the build configuration for the application:</p>
<div class="codehilite"><pre><span></span>oc describe bc/reefersimulator
</pre></div>

</li>
<li>
<p>When you want to redeploy, trigger a remote build (run on Openshift) from local source code do the following command:</p>
<div class="codehilite"><pre><span></span>oc start-build reefersimulator --from-file=.
</pre></div>

</li>
<li>
<p>Set environment variables</p>
<p>For Broker URLs
<div class="codehilite"><pre><span></span>oc set env dc/reefersimulator KAFKA_BROKERS=kafka03-prod02.messagehub.services.us-south.blu....
</pre></div></p>
<p>For apikey:
<div class="codehilite"><pre><span></span>oc set env dc/reefersimulator KAFKA_APIKEY=&quot;&quot;
</pre></div></p>
<p>If you connect to event stream or kafka with SSL specify where to find the SSL certificate: </p>
<div class="codehilite"><pre><span></span> oc set env dc/reefersimulator KAFKA_CERT=&quot;/opt/app-root/src/es-cert.pem&quot;
</pre></div>

<p>Get all environment variables set for a given pod: (get the pod id with <code>oc get pod</code>)</p>
<div class="codehilite"><pre><span></span>oc exec reefersimulator-31-2kdv5 env
</pre></div>

<p><img alt="" src="../images/env-variables.png" /></p>
</li>
<li>
<p>Once the build is done you should see the container up and running</p>
<div class="codehilite"><pre><span></span>oc get pod

reefersimulator-3-build         0/1       Completed    0          15m
reefersimulator-3-jdh2v         1/1       Running      0          1m
</pre></div>

<div class="admonition note">
<p class="admonition-title">Note<p>The first time the container start, it may crash as the environment variables like KAFKA_APIKEY is not defined. You can use the  <code>./scripts/defEnvVarInOpenShift.sh</code> command to create the needed environment variables.</p>
</p>
</div>
</li>
<li>
<p>To make the webapp visible externally to the cluster, you need to add a <code>route</code> for this deployment. Login to the admin console and use <code>Create Route</code> button on top right of the screen, </p>
</li>
</ol>
<p><img alt="" src="../images/create-routes.png" /></p>
<p>Then enter a name and select the existing service</p>
<p><img alt="" src="../images/simul-route-create.png" /></p>
<p>Once created, the URL of the app is visible in the route list panel:</p>
<p><img alt="" src="../images/simul-route.png" /></p>
<p>Add the host name in your local /etc/hosts or be sure the hostname is defined in DNS server. Map to the IP address of the kubernetes proxy server end point.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../../analyze/ws-ml-dev/" title="Define the anomaly detection scoring model with Watson Studio" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Define the anomaly detection scoring model with Watson Studio
              </span>
            </div>
          </a>
        
        
          <a href="../dev-scoring/" title="Develop scoring app with cloud pak for application" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Develop scoring app with cloud pak for application
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.b806dc00.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>